#
# # Copyright ¬© 2023 Peak AI Limited. or its affiliates. All Rights Reserved.
# #
# # Licensed under the Apache License, Version 2.0 (the "License"). You
# # may not use this file except in compliance with the License. A copy of
# # the License is located at:
# #
# # https://github.com/PeakBI/peak-sdk/blob/main/LICENSE
# #
# # or in the "license" file accompanying this file. This file is
# # distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF
# # ANY KIND, either express or implied. See the License for the specific
# # language governing permissions and limitations under the License.
# #
# # This file is part of the peak-sdk.
# # see (https://github.com/PeakBI/peak-sdk)
# #
# # You should have received a copy of the APACHE LICENSE, VERSION 2.0
# # along with this program. If not, see <https://apache.org/licenses/LICENSE-2.0>
#
"""Peak blocks deployments commands."""
from typing import Dict, List, Optional

import typer
from peak.cli import args, helpers
from peak.cli.args import DRY_RUN, PAGING
from peak.output import Writer
from peak.press.blocks import Block
from rich.console import Console

app = typer.Typer()
console = Console()

_DEPLOYMENT_ID = typer.Argument(..., help="ID of the Block deployment to be used in this operation")

_DEPLOYMENT_ID_OPTION = typer.Option(None, help="ID of the Block deployment to be used in this operation")
_FALLBACK_PARAMS_FILE = typer.Option(
    None,
    help="File containing parameters to be used when deployment id is not present",
)


@app.command(short_help="Create a Block deployment.")
def create(
    ctx: typer.Context,
    file: str = args.TEMPLATE_PATH,
    params_file: Optional[str] = args.TEMPLATE_PARAMS_FILE,
    params: Optional[List[str]] = args.TEMPLATE_PARAMS,
    dry_run: Optional[bool] = DRY_RUN,  # noqa: ARG001
    paging: Optional[bool] = PAGING,  # noqa: ARG001
) -> None:
    """***Create*** a Block deployment This creates the resource described in the Block Spec.

    \b
    üß© ***Input file schema (yaml):***<br/>
    ```yaml
      body (map):
        metadata (map):
            name (string | required: false): Name of the deployment. Must be unique within the tenant.
            title (string | required: false): Title of the deployment.
            summary (string | required: false): Summary of the deployment.
            description (string | required: false): Description of the deployment.
            descriptionContentType (string | required: false): Content type of the description. Should be one of "text/plain" or "text/markdown".
            imageUrl (string | required: false): URL of the image to be associated with the block deployment.
            tags (list(map) | required: false):
                - name (string): Name of the tag.
        parameters (map | required: false):
            <parameterType> (map): Dictionary of parameters. Here the key is the type of the parameter. Currently only "run" type (run-time) parameters are supported.
                <parameterName> (string | boolean | number | list(string)): Value of the parameter. Here the key is the name of the parameter.
        revision (map | required: false):
            notes (string | required: false): Notes for the deployment revision.
        spec (map):
            id (string): ID of the block spec to be deployed.
            release (map | required: false):
                version (string): A valid semantic release version of the block spec.
    ```

    \b
    üìù ***Example usage:***
    ```bash
    peak blocks deployments create /path/to/body.yaml -v /path/to/params.yaml
    ```

    \b
    üÜó ***Response:***
    ```json
    {
        "id": "632a4e7c-ab86-4ecb-8f34-99b5da531ceb"
    }
    ```

    üîó [**API Documentation**](https://press.peak.ai/api-docs/index.htm#/Block%20Deployments/post_v1_blocks_deployments)
    """
    blocks_client: Block = ctx.obj["client"]
    writer = Writer()

    body = helpers.template_handler(file, params_file, params)
    body = helpers.remove_unknown_args(body, blocks_client.create_deployment)

    with writer.pager():
        response: Dict[str, str] = blocks_client.create_deployment(**body)
        writer.write(response)


@app.command("list", short_help="List Block deployments.")
def list_block_deployments(
    ctx: typer.Context,
    page_size: Optional[int] = args.PAGE_SIZE,
    page_number: Optional[int] = args.PAGE_NUMBER,
    status: Optional[List[str]] = args.STATUS_FILTER,
    name: Optional[str] = args.NAME_FILTER,
    title: Optional[str] = args.TITLE_FILTER,
    sort: Optional[List[str]] = args.SORT_KEYS,
    paging: Optional[bool] = PAGING,  # noqa: ARG001
) -> None:
    """***List*** Block deployments that have been created for the given tenant.

    \b
    üìù ***Example usage:***<br/>
    ```bash
    peak blocks deployments list --status=deployed,failed --page-size 10 --page-number 1
    ```

    \b
    üÜó ***Response:***
    ```
    {
        "deploymentsCount": 1,
        "deployments": [...],
        "pageCount": 1,
        "pageNumber": 1,
        "pageSize": 25
    }
    ```

    üîó [**API Documentation**](https://press.peak.ai/api-docs/index.htm#/Block%20Deployments/get_v1_blocks_deployments)
    """
    blocks_client: Block = ctx.obj["client"]
    writer = Writer()

    with writer.pager():
        response = blocks_client.list_deployments(
            status=status,
            name=name,
            sort=sort,
            title=title,
            page_size=page_size,
            page_number=page_number,
            return_iterator=False,
        )
        writer.write(response)


@app.command(short_help="Describe the Block deployment.")
def describe(
    ctx: typer.Context,
    deployment_id: str = _DEPLOYMENT_ID,
    paging: Optional[bool] = PAGING,  # noqa: ARG001
) -> None:
    """***Describe*** the Block deployment with details of its latest revision.

    \b
    üìù ***Example usage:***<br/>
    ```bash
    peak blocks deployments describe "632a4e7c-ab86-4ecb-8f34-99b5da531ceb"
    ```

    \b
    üÜó ***Response:***
    ```
    {
        "id": "632a4e7c-ab86-4ecb-8f34-99b5da531ceb",
        "kind": "app",
        "latestRevision": {...},
        "metadata": {...},
        "spec": {...}
        "parameters": {...}
    }
    ```

    üîó [**API Documentation**](https://press.peak.ai/api-docs/index.htm#/Block%20Deployments/get_v1_blocks_deployments__deploymentId_)
    """
    blocks_client: Block = ctx.obj["client"]
    writer = Writer()

    with writer.pager():
        response = blocks_client.describe_deployment(deployment_id)
        writer.write(response)


@app.command(short_help="Update the Block deployment metadata.")
def update_metadata(
    ctx: typer.Context,
    deployment_id: str = _DEPLOYMENT_ID,
    file: str = args.TEMPLATE_PATH,
    params_file: Optional[str] = args.TEMPLATE_PARAMS_FILE,
    params: Optional[List[str]] = args.TEMPLATE_PARAMS,
    dry_run: Optional[bool] = DRY_RUN,  # noqa: ARG001
    paging: Optional[bool] = PAGING,  # noqa: ARG001
) -> None:
    """***Update*** the Block deployment metadata.

    \b
    üß© ***Input file schema (yaml):***<br/>
    ```yaml
      body (map):
        name (string | required: false): Name of the deployment. Must be unique within the tenant.
        title (string | required: false): Title of the deployment.
        summary (string | required: false): Summary of the deployment.
        description (string | required: false): Description of the deployment.
        descriptionContentType (string | required: false): Content type of the description. Should be one of "text/plain" or "text/markdown".
        imageUrl (string | required: false): URL of the image to be associated with the block deployment.
        tags (list(map) | required: false):
            - name (string): Name of the tag.
    ```

    \b
    üìù ***Example usage:***
    ```bash
    peak blocks deployments update-metadata "632a4e7c-ab86-4ecb-8f34-99b5da531ceb" /path/to/body.yaml -v /path/to/params.yaml
    ```

    \b
    üÜó ***Response:***
    ```
    {
        "id": "632a4e7c-ab86-4ecb-8f34-99b5da531ceb"
        "kind": "workflow",
        "latestRevision": {...},
        "metadata": {...},
        "spec": {...}
    }
    ```

    üîó [**API Documentation**](https://press.peak.ai/api-docs/index.htm#/Block%20Deployments/patch_v1_blocks_deployments__deploymentId_)
    """
    blocks_client: Block = ctx.obj["client"]
    writer = Writer()

    body = helpers.template_handler(file, params_file, params)
    body = helpers.remove_unknown_args(body, blocks_client.update_deployment_metadata)

    with writer.pager():
        response = blocks_client.update_deployment_metadata(deployment_id, **body)
        writer.write(response)


@app.command(short_help="Delete a Block deployment.")
def delete(
    ctx: typer.Context,
    deployment_id: str = _DEPLOYMENT_ID,
    dry_run: Optional[bool] = DRY_RUN,  # noqa: ARG001
    paging: Optional[bool] = PAGING,  # noqa: ARG001
) -> None:
    """***Delete*** a Block deployment. This will delete the resource that was created as part of the deployment.

    \b
    üìù ***Example usage:***<br/>
    ```bash
    peak blocks deployments delete "632a4e7c-ab86-4ecb-8f34-99b5da531ceb"
    ```

    \b
    üÜó ***Response:***
    ```json
    {}
    ```

    üîó [**API Documentation**](https://press.peak.ai/api-docs/index.htm#/Block%20Deployments/delete_v1_blocks_deployments__deploymentId_)
    """
    blocks_client: Block = ctx.obj["client"]
    writer = Writer()

    with writer.pager():
        response = blocks_client.delete_deployment(deployment_id)
        writer.write(response)


@app.command(short_help="Get the parameters for a deployment at run time.")
def get_parameters(
    ctx: typer.Context,
    deployment_id: Optional[str] = _DEPLOYMENT_ID_OPTION,
    fallback_params_file: Optional[str] = _FALLBACK_PARAMS_FILE,
    paging: Optional[bool] = PAGING,  # noqa: ARG001
) -> None:
    """***Get*** all the parameters for a deployment at run time.

    \b
    üìù ***Example usage:***<br/>
    ```bash
    peak blocks deployments get-parameters --deployment-id=<deployment-id> --fallback-params-file=<path/to/fallback/params/file>
    ```

    \b
    üÜó ***Response:***
    ```
    {...}
    ```

    üîó [**API Documentation**](https://press.peak.ai/api-docs/index.htm#/Deployment%20Parameters/get_v1_deployments__deploymentId__parameters_run)
    """
    blocks_client: Block = ctx.obj["client"]
    writer = Writer()

    with writer.pager():
        response = blocks_client.get_parameters(
            deployment_id=deployment_id,
            fallback_params_file=fallback_params_file,
        )
        writer.write(response)


@app.command(short_help="Update the parameters for a deployment at run time.")
def patch_parameters(
    ctx: typer.Context,
    deployment_id: str = _DEPLOYMENT_ID,
    file: str = args.TEMPLATE_PATH,
    params_file: Optional[str] = args.TEMPLATE_PARAMS_FILE,
    params: Optional[List[str]] = args.TEMPLATE_PARAMS,
    dry_run: Optional[bool] = DRY_RUN,  # noqa: ARG001
    paging: Optional[bool] = PAGING,  # noqa: ARG001
) -> None:
    """***Update*** the parameters for a deployment at run time.

    \b
    üß© ***Input file schema (yaml):***<br/>
    ```yaml
    body (map):
        <key> (string | boolean | number | list(string)): Value of the parameter. Here the key is the name of the parameter.
    ```

    \b
    üìù ***Example usage:***
    ```bash
    peak blocks deployments patch-parameters <deployment-id> /path/to/body.yaml -v /path/to/params.yaml
    ```

    \b
    üÜó ***Response:***
    ```
    {...}
    ```

    üîó [**API Documentation**](https://press.peak.ai/api-docs/index.htm#/Deployment%20Parameters/patch_v1_deployments__deploymentId__parameters_run)
    """
    body = helpers.template_handler(file, params_file, params)
    blocks_client: Block = ctx.obj["client"]
    body = helpers.remove_unknown_args(body, blocks_client.patch_parameters)
    writer = Writer()

    with writer.pager():
        response = blocks_client.patch_parameters(deployment_id, **body)
        writer.write(response)
